name: Docker Hub Publish (Gateway)

on:
  workflow_dispatch:
    inputs:
      upstream_tag:
        description: "Upstream release tag (example: v1.12.0)"
        required: true
        type: string
      packaging_rev:
        description: "Packaging revision number for same upstream version (example: 1)"
        required: true
        default: "1"
        type: string
      publish_latest:
        description: "Also publish :latest after successful smoke checks"
        required: false
        default: false
        type: boolean

env:
  REGISTRY: docker.io
  IMAGE: salesengr/google-workspace-mcp

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate tag inputs
        run: |
          set -euo pipefail
          if ! [[ "${{ inputs.upstream_tag }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([-.][0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid upstream_tag. Expected semver-style tag like v1.12.0"
            exit 1
          fi
          if ! [[ "${{ inputs.packaging_rev }}" =~ ^[0-9]+$ ]]; then
            echo "Invalid packaging_rev. Expected numeric value like 1"
            exit 1
          fi

      - name: Secret scan gate (hardcoded secret prevention)
        run: |
          set -euo pipefail
          docker run --rm -v "$PWD":/repo zricethezav/gitleaks:latest \
            detect --source /repo --no-git --redact --verbose

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: vars
        run: |
          set -euo pipefail
          V="${{ inputs.upstream_tag }}"
          R="${{ inputs.packaging_rev }}"
          echo "IMMUTABLE=${{ env.IMAGE }}:${V}-r${R}" >> "$GITHUB_OUTPUT"
          echo "UPSTREAM=${{ env.IMAGE }}:upstream-${V}" >> "$GITHUB_OUTPUT"
          echo "SHA=${{ env.IMAGE }}:sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Build and push multi-arch image
        id: docker_build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.gateway
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ steps.vars.outputs.IMMUTABLE }}
            ${{ steps.vars.outputs.UPSTREAM }}
            ${{ steps.vars.outputs.SHA }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke test container process startup
        run: |
          set -euo pipefail
          docker run -d --name gwm-smoke -p 18000:8000 \
            -e GOOGLE_OAUTH_CLIENT_ID=test \
            -e GOOGLE_OAUTH_CLIENT_SECRET=test \
            -e GOOGLE_CLOUD_PROJECT=test \
            -e GOOGLE_CLOUD_LOCATION=global \
            ${{ steps.vars.outputs.IMMUTABLE }}
          sleep 12
          docker logs gwm-smoke || true
          docker inspect --format='{{.State.Running}}' gwm-smoke | grep true
          docker rm -f gwm-smoke

      - name: Publish latest tag (optional)
        if: ${{ inputs.publish_latest == true }}
        run: |
          docker buildx imagetools create \
            -t ${{ env.IMAGE }}:latest \
            ${{ steps.vars.outputs.IMMUTABLE }}

      - name: Release summary
        run: |
          echo "## Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ env.IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Upstream tag: \`${{ inputs.upstream_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Packaging revision: \`r${{ inputs.packaging_rev }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Digest: \`${{ steps.docker_build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ steps.vars.outputs.IMMUTABLE }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ steps.vars.outputs.UPSTREAM }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ steps.vars.outputs.SHA }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.publish_latest }}" = "true" ]; then
            echo "- ${{ env.IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          fi
